<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterChess - Dashboard del Profesor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Compiler (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // These global variables are provided by the canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Make Firebase services globally available for the React component.
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch };
        window.firebaseConfig = firebaseConfig;
        window.initialAuthToken = initialAuthToken;
        window.appId = appId;
    </script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom animation classes for Tailwind */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); } to { transform: scale(1); } }
        @keyframes slideInFromTop { from { transform: translateY(-1.25rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .animate-in { animation-duration: 300ms; animation-timing-function: cubic-bezier(0.2, 0, 0, 1); }
        .fade-in-0 { animation-name: fadeIn; }
        .zoom-in-95 { animation-name: zoomIn; }
        .slide-in-from-top-5 { animation-name: slideInFromTop; }
        .no-print { display: none; }
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-report, .printable-report * {
                visibility: visible;
            }
            .printable-report {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            .print-comments {
                display: block !important;
            }
        }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        // Global variables provided by the canvas environment.
        const { useState, useMemo, useEffect } = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, writeBatch } = window.firebase;
        const firebaseConfig = window.firebaseConfig;
        const initialAuthToken = window.initialAuthToken;
        const appId = window.appId;

        // Initialize Firebase.
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ICONS (inlined as SVG for portability) ---
        const Users = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg> );
        const CheckCircle = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><polyline points="22 4 12 14.01 9 11.01" /></svg> );
        const Circle = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /></svg> );
        const Printer = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></svg> );
        const X = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg> );
        const PlusCircle = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="16" /><line x1="8" y1="12" x2="16" y2="12" /></svg> );
        const ChevronRight = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 18 15 12 9 6" /></svg> );
        const School = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4" /><path d="M18 10v6" /><path d="M6 10v6" /><path d="M2 12h20" /><path d="m6 10 6-6 6 6" /><path d="M10 4v3" /><path d="M14 4v2" /></svg> );
        const BookMarked = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20" /></svg> );
        const LinkIcon = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72" /></svg> );
        const Trash2 = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /></svg> );
        const AlertTriangle = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></svg> );
        const ArrowLeft = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></svg> );
        const CalendarDays = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg> );
        const Filter = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></svg> );
        const Loader2 = (props) => ( <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg> );


        // --- MOCK DATA & HELPERS ---
        const generateId = () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 20; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        };
        const DEFAULT_CURRICULUM = {
            categories: [ { id: 'cat_1', name: 'Fundamentos' }, { id: 'cat_2', name: 'T√°ctica B√°sica' }, { id: 'cat_3', name: 'Finales Esenciales' } ],
            skills: [ { id: 'skill_1', name: 'Movimientos', icon: '‚ôô', categoryId: 'cat_1', resourceLink: '' }, { id: 'skill_2', name: 'El Enroque', icon: '‚ôñ', categoryId: 'cat_1', resourceLink: '' }, { id: 'skill_3', name: 'Valor de Piezas', icon: 'üíé', categoryId: 'cat_1', resourceLink: '' }, { id: 'skill_4', name: 'La Clavada', icon: 'üìå', categoryId: 'cat_2', resourceLink: '' }, { id: 'skill_5', name: 'Ataque Doble', icon: 'üç¥', categoryId: 'cat_2', resourceLink: '' }, { id: 'skill_6', name: 'Mate de Rey y Torre', icon: 'üëë', categoryId: 'cat_3', resourceLink: '' } ]
        };

        // --- UI COMPONENTS ---
        const Toast = ({ message, type, onDismiss }) => { useEffect(() => { const timer = setTimeout(onDismiss, 3000); return () => clearTimeout(timer); }, [onDismiss]); const baseStyle = "fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white text-sm font-semibold z-[100] transition-all duration-300 animate-in fade-in-0 slide-in-from-top-5"; const typeStyle = type === 'success' ? 'bg-green-500/90' : 'bg-red-500/90'; return <div className={`${baseStyle} ${typeStyle}`}>{message}</div>; };
        const LoadingScreen = () => ( <div className="min-h-screen flex items-center justify-center bg-slate-900 flex-col text-slate-400"><Loader2 size={48} /><p className="mt-4">Cargando...</p></div> );


        // --- MODAL COMPONENTS ---
        const ModalWrapper = ({ children, onClose, title }) => ( <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in-0"><div className="bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl transition-all duration-300 scale-95 animate-in fade-in-0 zoom-in-95"><header className="p-4 flex justify-between items-center border-b border-slate-700"><h2 className="text-lg font-bold text-white">{title}</h2><button onClick={onClose} className="p-2 text-slate-300 hover:text-white hover:bg-slate-700 rounded-full transition-colors"><X size={20}/></button></header>{children}</div></div> );
        const ConfirmDeleteModal = ({ onClose, onConfirm, message }) => ( <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in-0"><div className="bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl p-6 transition-all duration-300 scale-95 animate-in fade-in-0 zoom-in-95"><div className="flex items-start"><div className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50 sm:mx-0 sm:h-10 sm:w-10"><AlertTriangle className="h-6 w-6 text-red-400" /></div><div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left"><h3 className="text-lg leading-6 font-medium text-white">Confirmar Eliminaci√≥n</h3><div className="mt-2"><p className="text-sm text-slate-300">{message}</p></div></div></div><div className="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse"><button type="button" onClick={() => { onConfirm(); onClose(); }} className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 sm:ml-3 sm:w-auto sm:text-sm transition-colors">Eliminar</button><button type="button" onClick={onClose} className="mt-3 w-full inline-flex justify-center rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-700 text-base font-medium text-white hover:bg-slate-600 sm:mt-0 sm:w-auto sm:text-sm transition-colors">Cancelar</button></div></div></div> );
        const AddItemModal = ({ onClose, onAdd, itemType, placeholder }) => { const [name, setName] = useState(''); const handleSubmit = (e) => { e.preventDefault(); if (name.trim()) { onAdd({ name: name.trim() }); onClose(); } }; return ( <ModalWrapper onClose={onClose} title={`A√±adir Nuevo ${itemType}`}><form onSubmit={handleSubmit} className="p-6 space-y-4"><div><label className="text-sm font-medium text-slate-300">Nombre del {itemType}</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} required autoFocus className="mt-1 w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white text-sm" placeholder={placeholder}/></div><div className="flex justify-end pt-2"><button type="submit" className="bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all">A√±adir {itemType}</button></div></form></ModalWrapper> ); };
        const AddStudentModal = ({ onClose, onAddStudent }) => { const [name, setName] = useState(''); const [avatar, setAvatar] = useState('üëß'); const handleSubmit = (e) => { e.preventDefault(); if (name.trim()) { onAddStudent({ name: name.trim(), avatar }); onClose(); } }; return ( <ModalWrapper onClose={onClose} title="A√±adir Nuevo Alumno"><form onSubmit={handleSubmit} className="p-6 space-y-4"><div><label className="text-sm font-medium text-slate-300">Nombre Completo</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} required autoFocus className="mt-1 w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white text-sm" placeholder="Ej: Ana L√≥pez"/></div><div><label className="text-sm font-medium text-slate-300">Seleccionar Avatar</label><div className="mt-2 flex gap-4"><button type="button" onClick={() => setAvatar('üëß')} className={`p-4 rounded-full text-3xl transition-all ${avatar === 'üëß' ? 'bg-sky-500 ring-2 ring-offset-2 ring-offset-slate-800 ring-white' : 'bg-slate-600 hover:bg-slate-500'}`}>üëß</button><button type="button" onClick={() => setAvatar('üë¶')} className={`p-4 rounded-full text-3xl transition-all ${avatar === 'üë¶' ? 'bg-sky-500 ring-2 ring-offset-2 ring-offset-slate-800 ring-white' : 'bg-slate-600 hover:bg-slate-500'}`}>üë¶</button></div></div><div className="flex justify-end pt-2"><button type="submit" className="bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all">A√±adir Alumno</button></div></form></ModalWrapper> ); };
        const AddSkillModal = ({ onClose, onAddSkill, categories }) => { const [name, setName] = useState(''); const [icon, setIcon] = useState(''); const [categoryId, setCategoryId] = useState(categories[0]?.id || ''); const [resourceLink, setResourceLink] = useState(''); const handleSubmit = (e) => { e.preventDefault(); if (name.trim() && categoryId) { onAddSkill({ name: name.trim(), icon, categoryId, resourceLink: resourceLink.trim() }); onClose(); } }; return ( <ModalWrapper onClose={onClose} title="Crear Nueva Habilidad"><form onSubmit={handleSubmit} className="p-6 space-y-4"><div><label className="text-sm font-medium text-slate-300">Nombre de la Habilidad</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} required autoFocus className="mt-1 w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white text-sm" placeholder="Ej: El Ataque Doble"/></div><div><label className="text-sm font-medium text-slate-300">Categor√≠a</label><select value={categoryId} onChange={(e) => setCategoryId(e.target.value)} required className="mt-1 w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white text-sm">{categories.length === 0 ? <option disabled>Crea una categor√≠a primero</option> : categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div><div><label className="text-sm font-medium text-slate-300">Enlace a Recurso (Opcional)</label><input type="url" value={resourceLink} onChange={(e) => setResourceLink(e.target.value)} className="mt-1 w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white text-sm" placeholder="https://..."/></div><div><label className="text-sm font-medium text-slate-300">Icono (Emoji Opcional)</label><input type="text" value={icon} onChange={(e) => setIcon(e.target.value)} maxLength="2" className="mt-1 w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white text-sm"/></div><div className="flex justify-end pt-2"><button type="submit" disabled={categories.length === 0} className="bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all disabled:from-slate-600 disabled:to-slate-700 disabled:cursor-not-allowed">Crear Habilidad</button></div></form></ModalWrapper> ); };
        const ManageStudentModal = ({ student, allSkills, onClose, onUpdateSkills, onGenerateReport }) => { const [masteredSkills, setMasteredSkills] = useState(student.masteredSkills.map(s => s.id)); const handleSkillChange = (skillId) => { setMasteredSkills(prev => prev.includes(skillId) ? prev.filter(id => id !== skillId) : [...prev, skillId]); }; const handleSaveChanges = () => { onUpdateSkills(student.id, masteredSkills); onClose(); }; return ( <ModalWrapper onClose={onClose} title=""><div className="flex flex-col h-full"><header className="p-4 flex justify-between items-center border-b border-slate-700"><div className="flex items-center"><span className="text-3xl mr-3">{student.avatar}</span><div><h2 className="text-lg font-bold text-white">{student.name}</h2><p className="text-xs text-slate-400">Gestionar Progreso</p></div></div><button onClick={onClose} className="p-2 text-slate-300 hover:text-white hover:bg-slate-700 rounded-full transition-colors"><X size={20}/></button></header><div className="p-6 overflow-y-auto"><h3 className="font-bold text-white mb-4">Marcar Habilidades Dominadas</h3><div className="grid grid-cols-2 md:grid-cols-3 gap-3">{allSkills.map(skill => (<label key={skill.id} className="flex items-center p-3 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition-colors"><input type="checkbox" checked={masteredSkills.includes(skill.id)} onChange={() => handleSkillChange(skill.id)} className="w-5 h-5 rounded text-sky-500 bg-slate-600 border-slate-500 focus:ring-sky-500"/><span className="ml-3 text-sm font-medium text-white">{skill.name}</span></label>))}</div></div><footer className="p-4 mt-auto border-t border-slate-700 flex justify-between items-center"><button onClick={() => onGenerateReport(student)} className="flex items-center font-medium text-sky-400 hover:underline"><Printer size={16} className="mr-2"/>Generar Informe</button><button onClick={handleSaveChanges} className="bg-gradient-to-br from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all">Guardar Cambios</button></footer></div></ModalWrapper> ); };
        const StudentReportModal = ({ student, allSkills, onClose, skillsData }) => { const [comments, setComments] = useState(`¬°Gran trabajo esta semana, ${student.name.split(' ')[0]}! Has progresado mucho. Para la pr√≥xima semana, vamos a enfocarnos en... ¬°Sigue as√≠!`); const masteredIds = student.masteredSkills.map(s => s.id); const printReport = () => window.print(); const copyLink = () => { alert('¬°Enlace copiado al portapapeles! (Funcionalidad simulada)'); }; return ( <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in-0"><div className="bg-slate-800 w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-2xl flex flex-col transition-all duration-300 scale-95 animate-in fade-in-0 zoom-in-95"><header className="p-4 flex justify-between items-center border-b border-slate-700 no-print"><h2 className="text-lg font-bold text-white">Informe de Progreso</h2><div><button onClick={copyLink} className="p-2 text-slate-300 hover:text-white hover:bg-slate-700 rounded-full mr-2 transition-colors"><LinkIcon size={20}/></button><button onClick={printReport} className="p-2 text-slate-300 hover:text-white hover:bg-slate-700 rounded-full mr-2 transition-colors"><Printer size={20}/></button><button onClick={onClose} className="p-2 text-slate-300 hover:text-white hover:bg-slate-700 rounded-full transition-colors"><X size={20}/></button></div></header><div className="p-8 overflow-y-auto printable-report bg-white text-slate-800"><div className="flex items-center justify-between border-b pb-4 mb-6"><div><h1 className="text-3xl font-bold font-sans">MasterChess</h1><p className="text-slate-500 font-sans">Informe de Progreso</p></div><div className="text-right"><p className="font-semibold font-sans">{student.name}</p><p className="text-sm text-slate-600 font-sans">Fecha: {new Date().toLocaleDateString('es-ES')}</p></div></div><div className="grid grid-cols-3 gap-6 mb-8"><div className="bg-sky-100 p-4 rounded-lg text-center"><p className="text-3xl font-bold text-sky-700 font-sans">{student.masteredSkills.length}</p><p className="text-sm font-semibold text-sky-600 font-sans">Insignias</p></div><div className="bg-amber-100 p-4 rounded-lg text-center"><p className="text-3xl font-bold text-amber-700 font-sans">{allSkills.length}</p><p className="text-sm font-semibold text-amber-600 font-sans">Habilidades</p></div><div className="bg-green-100 p-4 rounded-lg text-center"><p className="text-3xl font-bold text-green-700 font-sans">{allSkills.length > 0 ? Math.round((student.masteredSkills.length / allSkills.length) * 100) : 0}%</p><p className="text-sm font-semibold text-green-600 font-sans">Progreso</p></div></div><h3 className="font-bold text-xl mb-4 font-sans">Habilidades Dominadas</h3><div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">{allSkills.map(skill => (<div key={skill.id} className={`p-3 rounded-lg flex items-center ${masteredIds.includes(skill.id) ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-400'}`}>{masteredIds.includes(skill.id) ? <CheckCircle size={16} className="mr-2 flex-shrink-0"/> : <Circle size={16} className="mr-2 flex-shrink-0"/>}<span className="text-sm font-medium font-sans">{skill.name}</span></div>))}</div><h3 className="font-bold text-xl mb-2 font-sans">Comentarios del Profesor</h3><textarea className="w-full border rounded-lg p-4 h-32 text-slate-600 no-print font-sans" value={comments} onChange={(e) => setComments(e.target.value)}></textarea><div className="hidden print-comments border rounded-lg p-4 h-32 text-slate-600 font-sans"><p>{comments}</p></div></div></div></div> ); };
        const AttendanceModal = ({ onClose, onSave, students, attendanceRecord }) => { const [presentIds, setPresentIds] = useState(attendanceRecord?.present || []); const handleToggle = (id) => setPresentIds(prev => prev.includes(id) ? prev.filter(sId => sId !== id) : [...prev, id]); const handleSave = () => { onSave(presentIds); onClose(); }; return ( <ModalWrapper onClose={onClose} title={`Pasar Lista - ${new Date().toLocaleDateString('es-ES')}`}><div className="p-6 overflow-y-auto space-y-3">{students.map(student => (<label key={student.id} className="flex items-center p-3 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition-colors"><input type="checkbox" checked={presentIds.includes(student.id)} onChange={() => handleToggle(student.id)} className="w-5 h-5 rounded text-sky-500 bg-slate-600 border-slate-500 focus:ring-sky-500"/><span className="ml-4 text-sm font-medium text-white flex items-center"><span className="text-xl mr-3">{student.avatar}</span>{student.name}</span></label>))}</div><footer className="p-4 mt-auto border-t border-slate-700 flex justify-end"><button onClick={handleSave} className="bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all">Guardar Asistencia</button></footer></ModalWrapper> ); };
        const OnboardingModal = ({ onComplete }) => {
            const [step, setStep] = useState(1);
            const [collegeName, setCollegeName] = useState('');
            const [className, setClassName] = useState('');

            const handleNext = () => setStep(s => s + 1);
            const handleFinish = (importTemplate) => { onComplete({ collegeName, className, importTemplate }); };

            return (
                <div className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-in fade-in-0">
                    <div className="bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl transition-all duration-300 scale-95 animate-in fade-in-0 zoom-in-95">
                        {step === 1 && (<div className="p-6 text-center">
                            <h2 className="text-2xl font-bold text-white">¬°Bienvenido a MasterChess!</h2>
                            <p className="text-slate-300 mt-2 mb-6">Vamos a configurar tu primera clase en menos de un minuto.</p>
                            <button onClick={handleNext} className="bg-gradient-to-br from-sky-500 to-sky-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg">Empezar</button>
                        </div>)}
                        {step === 2 && (<div className="p-6">
                            <h2 className="text-xl font-bold text-white mb-4">Paso 1: Tu primer colegio</h2>
                            <label className="text-sm font-medium text-slate-300">Nombre del Colegio</label>
                            <input type="text" value={collegeName} onChange={(e) => setCollegeName(e.target.value)} autoFocus className="mt-1 w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white text-sm" placeholder="Ej: Colegio Cervantes"/>
                            <div className="flex justify-end pt-4"><button onClick={handleNext} disabled={!collegeName.trim()} className="bg-gradient-to-br from-sky-500 to-sky-600 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50">Siguiente</button></div>
                        </div>)}
                        {step === 3 && (<div className="p-6">
                            <h2 className="text-xl font-bold text-white mb-4">Paso 2: Tu primera clase</h2>
                            <label className="text-sm font-medium text-slate-300">Nombre de la Clase</label>
                            <input type="text" value={className} onChange={(e) => setClassName(e.target.value)} autoFocus className="mt-1 w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white text-sm" placeholder="Ej: Iniciaci√≥n Martes"/>
                            <div className="flex justify-end pt-4"><button onClick={handleNext} disabled={!className.trim()} className="bg-gradient-to-br from-sky-500 to-sky-600 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50">Siguiente</button></div>
                        </div>)}
                        {step === 4 && (<div className="p-6 text-center">
                            <h2 className="text-xl font-bold text-white mb-4">Paso 3: Tu temario</h2>
                            <p className="text-slate-300 mb-6">Para ahorrarte tiempo, ¬øquieres importar un temario de iniciaci√≥n est√°ndar? Podr√°s editarlo m√°s tarde.</p>
                            <div className="flex gap-4 justify-center">
                                <button onClick={() => handleFinish(false)} className="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg">Empezar desde Cero</button>
                                <button onClick={() => handleFinish(true)} className="bg-gradient-to-br from-sky-500 to-sky-600 text-white font-bold py-2 px-4 rounded-lg">S√≠, importar plantilla</button>
                            </div>
                        </div>)}
                    </div>
                </div>
            );
        };
        const BatchAssignModal = ({ onClose, onAssign, studentIds, skills }) => {
            const [selectedSkillId, setSelectedSkillId] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (selectedSkillId) { onAssign(studentIds, selectedSkillId); onClose(); } };
            return (
                <ModalWrapper onClose={onClose} title="Asignar Habilidad en Lote">
                    <form onSubmit={handleSubmit} className="p-6 space-y-4">
                        <p className="text-sm text-slate-300">Vas a asignar una habilidad a <span className="font-bold text-white">{studentIds.length}</span> alumnos seleccionados.</p>
                        <div><label className="text-sm font-medium text-slate-300">Selecciona la Habilidad</label><select value={selectedSkillId} onChange={(e) => setSelectedSkillId(e.target.value)} required className="mt-1 w-full bg-slate-700 border border-slate-600 rounded-md p-2 text-white text-sm"><option value="" disabled>-- Elige una habilidad --</option>{skills.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                        <div className="flex justify-end pt-2"><button type="submit" className="bg-gradient-to-br from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all">Asignar a Todos</button></div>
                    </form>
                </ModalWrapper>
            );
        };

        // --- MAIN VIEWS ---
        const Header = ({ onLogout, setView, userId }) => ( <header className="bg-slate-800/50 backdrop-blur-sm p-4 flex justify-between items-center border-b border-slate-700 sticky top-0 z-20"><div className="flex items-center"><Users className="mr-3 text-amber-400" size={28}/><h1 className="text-lg font-bold">MasterChess Dashboard</h1></div><div className="flex items-center gap-2"><p className="text-xs text-slate-500 truncate">{userId}</p><button onClick={() => setView('curriculum')} className="hidden sm:flex items-center bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-colors"><BookMarked size={16} className="mr-2"/>Editor de Temario</button><button onClick={onLogout} className="bg-slate-700 hover:bg-red-500/80 p-2 rounded-full transition-colors"><X size={20}/></button></div></header> );
        const Breadcrumbs = ({ path, setPath, teacherData, setView }) => ( <div className="px-4 md:px-8 pt-6 flex items-center text-sm text-slate-400"><button onClick={() => { setPath({}); setView('colleges'); }} className="hover:text-white">Mis Colegios</button>{path.collegeId && ( <> <ChevronRight size={16} className="mx-1" /> <button onClick={() => { setPath({ collegeId: path.collegeId }); setView('classes'); }} className="hover:text-white">{teacherData.colleges.find(c=>c.id === path.collegeId)?.name}</button> </> )}{path.classId && ( <> <ChevronRight size={16} className="mx-1" /> <span className="font-semibold text-white">{teacherData.colleges.find(c=>c.id === path.collegeId)?.classes.find(cl=>cl.id === path.classId)?.name}</span> </> )}</div> );
        const CollegesView = ({ teacherData, onOpenModal, setPath, setView }) => ( <div className="p-4 md:p-8"><div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-white">Mis Colegios</h2><button onClick={() => onOpenModal('addCollege')} className="flex items-center bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow-md hover:shadow-lg transition-all"><PlusCircle size={16} className="mr-2"/>A√±adir Colegio</button></div>{teacherData.colleges.length === 0 ? (<div className="text-center bg-slate-800 p-12 rounded-lg"><School size={48} className="mx-auto text-slate-600 mb-4"/><h3 className="text-xl font-semibold text-white">Empieza por a√±adir tu primer colegio</h3><p className="text-slate-400 mt-2">Organiza tus clases y alumnos por cada centro en el que ense√±as.</p></div>) : (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{teacherData.colleges.map(college => (<div key={college.id} className="bg-slate-800 p-6 rounded-lg shadow-lg group transition-all duration-300 hover:shadow-sky-500/20 hover:ring-1 hover:ring-slate-700 hover:-translate-y-1"><div onClick={() => { setPath({ collegeId: college.id }); setView('classes'); }} className="cursor-pointer"><div className="flex justify-between items-start"><div className="flex items-center mb-2"><School className="text-sky-400 mr-3" size={24}/><div><h3 className="text-xl font-bold text-white group-hover:text-sky-400 transition-colors">{college.name}</h3></div></div><ChevronRight className="opacity-50 group-hover:opacity-100 transition-opacity"/></div><p className="text-sm text-slate-400">{college.classes.length} clases</p></div><div className="mt-4 border-t border-slate-700 pt-2 flex justify-end"><button onClick={(e) => { e.stopPropagation(); onOpenModal('confirmDelete', { onConfirm: () => onOpenModal('deleteCollege', college.id), message: `¬øSeguro que quieres eliminar "${college.name}" y todas sus clases?` })}} className="p-1 text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={16}/></button></div></div>))}</div>)}</div> );
        const ClassesView = ({ college, onOpenModal, setPath, setView }) => ( <div className="p-4 md:p-8"><div className="flex justify-between items-center mb-6"><div className="flex items-center gap-4"><button onClick={() => { setPath({}); setView('colleges'); }} className="p-2 bg-slate-700 rounded-full hover:bg-slate-600 transition-colors"><ArrowLeft size={20}/></button><h2 className="text-2xl font-bold text-white">Clases en {college.name}</h2></div><button onClick={() => onOpenModal('addClass')} className="flex items-center bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow-md hover:shadow-lg transition-all"><PlusCircle size={16} className="mr-2"/>A√±adir Clase</button></div>{college.classes.length === 0 ? (<div className="text-center bg-slate-800 p-12 rounded-lg"><Users size={48} className="mx-auto text-slate-600 mb-4"/><h3 className="text-xl font-semibold text-white">No hay clases en este colegio todav√≠a</h3><p className="text-slate-400 mt-2">A√±ade tu primera clase para empezar a gestionar alumnos.</p></div>) : (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{college.classes.map(cls => (<div key={cls.id} className="bg-slate-800 p-6 rounded-lg shadow-lg group transition-all duration-300 hover:shadow-sky-500/20 hover:ring-1 hover:ring-slate-700 hover:-translate-y-1"><div onClick={() => { setPath(p => ({ ...p, classId: cls.id })); setView('classDashboard'); }} className="cursor-pointer"><div className="flex justify-between items-start"><h3 className="text-xl font-bold text-white mb-2 group-hover:text-sky-400 transition-colors">{cls.name}</h3><ChevronRight className="opacity-50 group-hover:opacity-100 transition-opacity"/></div><p className="text-sm text-slate-400">{cls.students.length} alumnos</p></div><div className="mt-4 border-t border-slate-700 pt-2 flex justify-end"><button onClick={(e) => { e.stopPropagation(); onOpenModal('confirmDelete', { onConfirm: () => onOpenModal('deleteClass', cls.id), message: `¬øSeguro que quieres eliminar la clase "${cls.name}"?` })}} className="p-1 text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={16}/></button></div></div>))}</div>)}</div> );
        const ClassDashboard = ({ cls, skills, onOpenModal, setPath, path, setView }) => { const [selectedStudents, setSelectedStudents] = useState([]); const [focusMode, setFocusMode] = useState(false); const allSkills = useMemo(() => skills.sort((a,b) => (a.categoryId > b.categoryId) ? 1 : -1), [skills]); const handleSelectAll = (e) => { if (e.target.checked) { setSelectedStudents(cls.students.map(s => s.id)); } else { setSelectedStudents([]); } }; const handleSelectStudent = (studentId) => { setSelectedStudents(prev => prev.includes(studentId) ? prev.filter(id => id !== studentId) : [...prev, studentId]); }; const studentsToDisplay = useMemo(() => { if (!focusMode) return cls.students; return [...cls.students].sort((a, b) => a.masteredSkills.length - b.masteredSkills.length); }, [cls.students, focusMode]); return ( <div className="p-4 md:p-8"><div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><div className="flex items-center gap-4"><button onClick={() => { setPath({ collegeId: path.collegeId }); setView('classes'); }} className="p-2 bg-slate-700 rounded-full hover:bg-slate-600 transition-colors"><ArrowLeft size={20}/></button><h2 className="text-2xl font-bold text-white">Progreso de la Clase</h2></div><div className="flex gap-2 items-center">{selectedStudents.length > 0 ? (<button onClick={() => onOpenModal('batchAssign', selectedStudents)} className="flex items-center bg-gradient-to-br from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow-md hover:shadow-lg transition-all"><CheckCircle size={16} className="mr-2"/>Asignar Habilidad ({selectedStudents.length})</button>) : (<button onClick={() => onOpenModal('addStudent')} className="flex items-center bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow-md hover:shadow-lg transition-all"><PlusCircle size={16} className="mr-2"/>A√±adir Alumno</button>)}<button onClick={() => onOpenModal('attendance', cls)} className="flex items-center bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-colors"><CalendarDays size={16} className="mr-2"/>Pasar Lista</button><button onClick={() => setFocusMode(!focusMode)} className={`flex items-center py-2 px-3 rounded-lg text-sm transition-colors ${focusMode ? 'bg-sky-500 text-white' : 'bg-slate-700 hover:bg-slate-600'}`}><Filter size={16} className="mr-2"/>Foco</button></div></div>{cls.students.length === 0 ? (<div className="text-center bg-slate-800 p-12 rounded-lg"><Users size={48} className="mx-auto text-slate-600 mb-4"/><h3 className="text-xl font-semibold text-white">¬°Clase lista!</h3><p className="text-slate-400 mt-2">A√±ade tu primer alumno para registrar su progreso.</p></div>) : (<div className="overflow-x-auto bg-slate-800 rounded-lg shadow-lg"><table className="w-full text-sm text-left text-slate-300"><thead className="text-xs text-slate-400 uppercase bg-slate-700/50"><tr><th scope="col" className="p-4 sticky left-0 bg-slate-700/50 z-10"><input type="checkbox" onChange={handleSelectAll} className="w-4 h-4 rounded text-sky-500 bg-slate-600 border-slate-500"/></th><th scope="col" className="px-6 py-3 sticky left-12 bg-slate-700/50 z-10">Estudiante</th>{allSkills.map(skill => <th key={skill.id} scope="col" className="px-4 py-3 text-center" title={skill.name}>{skill.icon || skill.name.substring(0,3)}</th>)}<th scope="col" className="px-6 py-3 text-center">Acciones</th></tr></thead><tbody>{studentsToDisplay.map((student, index) => { const masteredIds = student.masteredSkills.map(s => s.id); const progress = allSkills.length > 0 ? (masteredIds.length / allSkills.length) * 100 : 0; const isInFocus = focusMode && progress < 50; return ( <tr key={student.id} className={`border-b border-slate-700 ${selectedStudents.includes(student.id) ? 'bg-sky-900/50' : (index % 2 === 0 ? 'bg-slate-800/50' : 'bg-transparent')} ${isInFocus ? 'bg-amber-500/10' : ''} hover:bg-slate-700/30`}><td className="p-4 sticky left-0 bg-inherit"><input type="checkbox" checked={selectedStudents.includes(student.id)} onChange={() => handleSelectStudent(student.id)} className="w-4 h-4 rounded text-sky-500 bg-slate-600 border-slate-500"/></td><th scope="row" className="px-6 py-4 font-medium text-white whitespace-nowrap sticky left-12 bg-inherit flex items-center"><span className="text-xl mr-3">{student.avatar}</span><div>{student.name}<div className="w-24 bg-slate-600 rounded-full h-1.5 mt-1"><div className="bg-amber-400 h-1.5 rounded-full" style={{width: `${progress}%`}}></div></div></div></th>{allSkills.map(skill => (<td key={`${student.id}-${skill.id}`} className="px-4 py-4 text-center">{masteredIds.includes(skill.id) ? <CheckCircle className="mx-auto text-amber-400" size={20}/> : <Circle className="mx-auto text-slate-600" size={20}/>}</td>))}<td className="px-6 py-4 text-center flex items-center justify-center gap-2"><button onClick={() => onOpenModal('manageStudent', student)} className="font-medium text-sky-400 hover:underline">Gestionar</button><button onClick={() => onOpenModal('confirmDelete', { onConfirm: () => onOpenModal('deleteStudent', student.id), message: `¬øSeguro que quieres eliminar a "${student.name}"?` })} className="p-1 text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={16}/></button></td></tr> );})}</tbody></table></div>)}</div> ); };
        const CurriculumEditor = ({ teacherData, onOpenModal, setView }) => ( <div className="p-4 md:p-8"><div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4"><div className="flex items-center gap-4"><button onClick={() => setView('colleges')} className="p-2 bg-slate-700 rounded-full hover:bg-slate-600 transition-colors"><ArrowLeft size={20}/></button><h2 className="text-2xl font-bold text-white">Editor de Temario</h2></div><div className="flex gap-2"><button onClick={() => onOpenModal('addCategory')} className="flex items-center bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-3 rounded-lg text-sm transition-colors"><PlusCircle size={16} className="mr-2"/>Nueva Categor√≠a</button><button onClick={() => onOpenModal('addSkill')} className="flex items-center bg-gradient-to-br from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-semibold py-2 px-3 rounded-lg text-sm shadow-md hover:shadow-lg transition-all"><PlusCircle size={16} className="mr-2"/>Nueva Habilidad</button></div></div><div className="space-y-8">{teacherData.categories.length === 0 ? <div className="text-center bg-slate-800 p-12 rounded-lg"><BookMarked size={48} className="mx-auto text-slate-600 mb-4"/><h3 className="text-xl font-semibold text-white">Crea tu curr√≠culo</h3><p className="text-slate-400 mt-2">A√±ade categor√≠as (ej. "T√°ctica") y luego habilidades dentro de ellas.</p></div> : teacherData.categories.map(category => (<div key={category.id} className="bg-slate-800/50 p-6 rounded-lg"><div className="flex justify-between items-center mb-3"><h3 className="text-xl font-semibold text-amber-400">{category.name}</h3><button onClick={() => onOpenModal('confirmDelete', { onConfirm: () => onOpenModal('deleteCategory', category.id), message: `¬øSeguro que quieres eliminar la categor√≠a "${category.name}"?` })} className="p-1 text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={16}/></button></div><div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">{teacherData.skills.filter(s => s.categoryId === category.id).map(skill => (<div key={skill.id} className="bg-slate-800 p-4 rounded-lg text-center relative group"><div className="absolute top-1 right-1 flex opacity-0 group-hover:opacity-100 transition-opacity"><a href={skill.resourceLink} target="_blank" rel="noopener noreferrer" className={`p-1 text-slate-500 hover:text-sky-400 ${!skill.resourceLink && 'hidden'}`}><LinkIcon size={14}/></a><button onClick={() => onOpenModal('confirmDelete', { onConfirm: () => onOpenModal('deleteSkill', skill.id), message: `¬øSeguro que quieres eliminar la habilidad "${skill.name}"?` })} className="p-1 text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={14}/></button></div><p className="text-2xl mt-4">{skill.icon}</p><p className="font-semibold mt-2">{skill.name}</p></div>))}</div></div>))}</div></div> );
        const LoginScreen = ({ onLogin }) => ( <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4"><div className="text-center mb-10"><h1 className="text-5xl font-bold text-white">MasterChess</h1><p className="text-slate-400 mt-2">Plataforma de Gesti√≥n para Profesores de Ajedrez</p></div><div className="w-full max-w-sm"><button onClick={onLogin} className="w-full bg-gradient-to-br from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white font-bold py-4 px-4 rounded-lg flex items-center justify-center text-lg shadow-lg hover:shadow-xl transition-all"><Users className="mr-3" size={20}/>Entrar al Dashboard</button></div><footer className="text-center text-slate-500 mt-10 text-sm"><p>&copy; 2025 MasterChess. Potenciando la ense√±anza del ajedrez.</p></footer></div> );


        function App() {
            // State for the entire app.
            const [teacherData, setTeacherData] = useState({ skills: [], categories: [], colleges: [] });
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [userId, setUserId] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [view, setView] = useState('colleges');
            const [path, setPath] = useState({});
            const [activeModal, setActiveModal] = useState({ type: null, data: null });
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            const [isOnboarding, setIsOnboarding] = useState(false);

            // Auth state listener.
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        setUserId(user.uid);
                        setIsLoggedIn(true);
                        // Fetch data from Firestore once authenticated.
                        listenToFirestoreData(user.uid);
                    } else {
                        // Sign in anonymously if no user is found.
                        await signInAnonymously(auth);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Function to listen to Firestore data in real time.
            const listenToFirestoreData = (uid) => {
                // Get a reference to the user's data document.
                const userDocRef = doc(db, `artifacts/${appId}/users/${uid}`);
                
                // Set up a real-time listener for the user's data.
                const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setTeacherData(docSnap.data());
                        setIsOnboarding(false);
                    } else {
                        // If no data exists, trigger the onboarding process.
                        setIsOnboarding(true);
                    }
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error listening to Firestore data:", error);
                    setIsLoading(false);
                    showToast("Error al cargar los datos. Int√©ntalo de nuevo.", "error");
                });
                return unsubscribe;
            };

            const saveDataToFirestore = async (data) => {
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}`);
                    await setDoc(userDocRef, data, { merge: true });
                } catch (e) {
                    console.error("Error saving data: ", e);
                    showToast("Error al guardar los datos.", "error");
                }
            };

            const showToast = (message, type = 'success') => { setToast({ show: true, message, type }); };

            const handleLogin = () => {
                setIsLoggedIn(true);
            };

            const handleLogout = async () => {
                setIsLoggedIn(false);
                setUserId(null);
                setTeacherData({ skills: [], categories: [], colleges: [] });
                setView('colleges');
                setPath({});
                // Note: We don't sign out to maintain the anonymous user session for persistence.
                // The onAuthStateChanged listener will handle a new session if needed.
            };

            const handleOnboardingComplete = async ({ collegeName, className, importTemplate }) => {
                let newTeacherData = { skills: [], categories: [], colleges: [] };
                
                const collegeId = generateId();
                const classId = generateId();
                const newCollege = { name: collegeName, id: collegeId, classes: [{ name: className, id: classId, students: [], attendance: [] }] };
                newTeacherData.colleges = [newCollege];
                
                if (importTemplate) {
                    const newCategories = DEFAULT_CURRICULUM.categories.map(c => ({...c, id: generateId()}));
                    const categoryIdMap = newCategories.reduce((acc, cur, i) => {
                        acc[DEFAULT_CURRICULUM.categories[i].id] = cur.id;
                        return acc;
                    }, {});
                    newTeacherData.categories = newCategories;
                    newTeacherData.skills = DEFAULT_CURRICULUM.skills.map(s => ({...s, id: generateId(), categoryId: categoryIdMap[s.categoryId]}));
                }
                
                // Save initial data to Firestore.
                await saveDataToFirestore(newTeacherData);
                setTeacherData(newTeacherData);
                setIsOnboarding(false);
                showToast("¬°Configuraci√≥n completada!");
            };

            // CRUD operations
            const handleAddCategory = (data) => {
                const newCategory = { ...data, id: generateId() };
                saveDataToFirestore({ categories: [...teacherData.categories, newCategory] });
                showToast("Categor√≠a a√±adida");
            };
            const handleAddSkill = (data) => {
                const newSkill = { ...data, id: generateId() };
                saveDataToFirestore({ skills: [...teacherData.skills, newSkill] });
                showToast("Habilidad creada");
            };
            const handleAddCollege = (data) => {
                const newCollege = { ...data, id: generateId(), classes: [] };
                saveDataToFirestore({ colleges: [...teacherData.colleges, newCollege] });
                showToast("Colegio a√±adido");
            };
            const handleAddClass = (data) => {
                const updatedColleges = teacherData.colleges.map(c => c.id === path.collegeId ? { ...c, classes: [...c.classes, { ...data, id: generateId(), students: [], attendance: [] }] } : c);
                saveDataToFirestore({ colleges: updatedColleges });
                showToast("Clase a√±adida");
            };
            const handleAddStudent = (data) => {
                const updatedColleges = teacherData.colleges.map(c => c.id === path.collegeId ? { ...c, classes: c.classes.map(cl => cl.id === path.classId ? { ...cl, students: [...cl.students, { ...data, id: generateId(), masteredSkills: [] }] } : cl) } : c);
                saveDataToFirestore({ colleges: updatedColleges });
                showToast("Alumno a√±adido");
            };
            const handleUpdateStudentSkills = (studentId, newSkillIds) => {
                const updatedColleges = teacherData.colleges.map(c => c.id === path.collegeId ? { ...c, classes: c.classes.map(cl => cl.id === path.classId ? { ...cl, students: cl.students.map(st => st.id === studentId ? { ...st, masteredSkills: newSkillIds.map(id => { const existing = st.masteredSkills.find(s => s.id === id); return existing || { id, date: new Date().toISOString().split('T')[0] }; }) } : st) } : cl) } : c);
                saveDataToFirestore({ colleges: updatedColleges });
                showToast("Progreso guardado");
            };
            const handleBatchAssignSkill = (studentIds, skillId) => {
                const updatedColleges = teacherData.colleges.map(c => c.id === path.collegeId ? { ...c, classes: c.classes.map(cl => cl.id === path.classId ? { ...cl, students: cl.students.map(st => studentIds.includes(st.id) && !st.masteredSkills.some(s => s.id === skillId) ? { ...st, masteredSkills: [...st.masteredSkills, { id: skillId, date: new Date().toISOString().split('T')[0] }] } : st) } : cl) } : c);
                saveDataToFirestore({ colleges: updatedColleges });
                showToast("Habilidad asignada en lote");
            };
            const handleTakeAttendance = (presentIds) => {
                const today = new Date().toISOString().split('T')[0];
                const updatedColleges = teacherData.colleges.map(c => c.id === path.collegeId ? { ...c, classes: c.classes.map(cl => {
                    if (cl.id === path.classId) {
                        const newAttendance = [...(cl.attendance || [])];
                        const todayRecordIndex = newAttendance.findIndex(rec => rec.date === today);
                        if (todayRecordIndex > -1) {
                            newAttendance[todayRecordIndex].present = presentIds;
                        } else {
                            newAttendance.push({ date: today, present: presentIds });
                        }
                        return { ...cl, attendance: newAttendance };
                    }
                    return cl;
                }) } : c);
                saveDataToFirestore({ colleges: updatedColleges });
                showToast("Asistencia guardada");
            };
            
            const handleDeleteCollege = (collegeId) => {
                saveDataToFirestore({ colleges: teacherData.colleges.filter(c => c.id !== collegeId) });
                showToast("Colegio eliminado", "error");
            };
            const handleDeleteClass = (classId) => {
                const updatedColleges = teacherData.colleges.map(c => c.id === path.collegeId ? { ...c, classes: c.classes.filter(cl => cl.id !== classId) } : c);
                saveDataToFirestore({ colleges: updatedColleges });
                showToast("Clase eliminada", "error");
            };
            const handleDeleteStudent = (studentId) => {
                const updatedColleges = teacherData.colleges.map(c => c.id === path.collegeId ? { ...c, classes: c.classes.map(cl => cl.id === path.classId ? { ...cl, students: cl.students.filter(st => st.id !== studentId) } : cl) } : c);
                saveDataToFirestore({ colleges: updatedColleges });
                showToast("Alumno eliminado", "error");
            };
            const handleDeleteCategory = (categoryId) => {
                const isUsed = teacherData.skills.some(s => s.categoryId === categoryId);
                if (isUsed) {
                    // Use a custom modal instead of alert
                    setActiveModal({ type: 'info', data: { message: "No se puede eliminar la categor√≠a porque contiene habilidades. Elimina o reasigna las habilidades primero." } });
                    return;
                }
                saveDataToFirestore({ categories: teacherData.categories.filter(c => c.id !== categoryId) });
                showToast("Categor√≠a eliminada", "error");
            };
            const handleDeleteSkill = (skillId) => {
                const updatedSkills = teacherData.skills.filter(s => s.id !== skillId);
                const updatedColleges = teacherData.colleges.map(c => ({
                    ...c,
                    classes: c.classes.map(cl => ({
                        ...cl,
                        students: cl.students.map(st => ({
                            ...st,
                            masteredSkills: st.masteredSkills.filter(ms => ms.id !== skillId)
                        }))
                    }))
                }));
                saveDataToFirestore({ skills: updatedSkills, colleges: updatedColleges });
                showToast("Habilidad eliminada", "error");
            };

            const allSkills = teacherData.skills;

            const handleOpenModal = (type, data) => {
                switch(type) {
                    case 'deleteCollege': handleDeleteCollege(data); break;
                    case 'deleteClass': handleDeleteClass(data); break;
                    case 'deleteStudent': handleDeleteStudent(data); break;
                    case 'deleteCategory': handleDeleteCategory(data); break;
                    case 'deleteSkill': handleDeleteSkill(data); break;
                    default: setActiveModal({ type, data });
                }
            };
            
            const renderContent = () => {
                switch(view) {
                    case 'curriculum': return <CurriculumEditor teacherData={teacherData} onOpenModal={handleOpenModal} setView={setView} />;
                    case 'classDashboard': const college = teacherData.colleges.find(c => c.id === path.collegeId); const cls = college?.classes.find(cl => cl.id === path.classId); return cls ? <ClassDashboard cls={cls} skills={teacherData.skills} onOpenModal={handleOpenModal} setPath={setPath} path={path} setView={setView} /> : null;
                    case 'classes': const col = teacherData.colleges.find(c => c.id === path.collegeId); return col ? <ClassesView college={col} onOpenModal={handleOpenModal} setPath={setPath} setView={setView} /> : null;
                    case 'colleges': default: return <CollegesView teacherData={teacherData} onOpenModal={handleOpenModal} setPath={setPath} setView={setView} />;
                }
            };

            if (isLoading) return <LoadingScreen />;
            if (!isLoggedIn) return <LoginScreen onLogin={handleLogin} />;
            if (isOnboarding) return <OnboardingModal onComplete={handleOnboardingComplete} />;

            return (
                <>
                    {toast.show && <Toast message={toast.message} type={toast.type} onDismiss={() => setToast({ ...toast, show: false })} />}
                    <div className="min-h-screen bg-slate-900 text-white font-sans">
                        <Header onLogout={handleLogout} setView={setView} userId={userId} />
                        {view !== 'curriculum' && <Breadcrumbs path={path} setPath={setPath} teacherData={teacherData} setView={setView} />}
                        {renderContent()}
                    </div>
                    {activeModal.type === 'addCollege' && <AddItemModal onClose={() => setActiveModal({ type: null })} onAdd={handleAddCollege} itemType="Colegio" placeholder="Ej: Colegio Cervantes"/>}
                    {activeModal.type === 'addClass' && <AddItemModal onClose={() => setActiveModal({ type: null })} onAdd={handleAddClass} itemType="Clase" placeholder="Ej: Avanzado Martes"/>}
                    {activeModal.type === 'addCategory' && <AddItemModal onClose={() => setActiveModal({ type: null })} onAdd={handleAddCategory} itemType="Categor√≠a" placeholder="Ej: T√°ctica B√°sica"/>}
                    {activeModal.type === 'addStudent' && <AddStudentModal onClose={() => setActiveModal({ type: null })} onAddStudent={handleAddStudent} />}
                    {activeModal.type === 'addSkill' && <AddSkillModal onClose={() => setActiveModal({ type: null })} onAddSkill={handleAddSkill} categories={teacherData.categories} />}
                    {activeModal.type === 'manageStudent' && <ManageStudentModal student={activeModal.data} allSkills={allSkills} onClose={() => setActiveModal({ type: null })} onUpdateSkills={handleUpdateStudentSkills} onGenerateReport={(student) => setActiveModal({ type: 'report', data: student })} />}
                    {activeModal.type === 'report' && <StudentReportModal student={activeModal.data} allSkills={allSkills} skillsData={teacherData.skills} onClose={() => setActiveModal({ type: 'manageStudent', data: activeModal.data })} />}
                    {activeModal.type === 'batchAssign' && <BatchAssignModal onClose={() => setActiveModal({ type: null })} onAssign={handleBatchAssignSkill} studentIds={activeModal.data} skills={allSkills} />}
                    {activeModal.type === 'confirmDelete' && <ConfirmDeleteModal onClose={() => setActiveModal({ type: null })} onConfirm={activeModal.data.onConfirm} message={activeModal.data.message} />}
                    {activeModal.type === 'attendance' && <AttendanceModal onClose={() => setActiveModal({ type: null })} onSave={handleTakeAttendance} students={activeModal.data.students} attendanceRecord={activeModal.data.attendance.find(a => a.date === new Date().toISOString().split('T')[0])} />}
                    {activeModal.type === 'info' && <ModalWrapper onClose={() => setActiveModal({ type: null })} title="Atenci√≥n"><div className="p-6 text-sm text-slate-300">{activeModal.data.message}</div><div className="flex justify-end pt-2"><button onClick={() => setActiveModal({ type: null })} className="bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button></div></ModalWrapper>}
                </>
            );
        }

        // --- RENDER THE APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
